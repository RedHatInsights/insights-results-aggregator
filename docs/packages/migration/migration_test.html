<!DOCTYPE html>
<!--
 Copyright 2020 Red Hat, Inc

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
<head>
<title>migration_test.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>migration_test.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"></td>
	<td class="code"><pre><code><div class="comment">/*
Copyright Â© 2020 Red Hat, Inc.

Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/</div>

<div class="keyword">package</div> <div class="ident">migration_test</div><div class="operator"></div>

<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;database/sql&#34;</div><div class="operator"></div>
	<div class="ident">sql_driver</div> <div class="literal">&#34;database/sql/driver&#34;</div><div class="operator"></div>
	<div class="literal">&#34;fmt&#34;</div><div class="operator"></div>
	<div class="literal">&#34;testing&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/DATA-DOG/go-sqlmock&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-operator-utils/tests/helpers&#34;</div><div class="operator"></div>
	<div class="ident">_</div> <div class="literal">&#34;github.com/mattn/go-sqlite3&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/rs/zerolog&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/stretchr/testify/assert&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/migration&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/storage&#34;</div><div class="operator"></div>
	<div class="ident">ira_helpers</div> <div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/tests/helpers&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/types&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

<div class="keyword">const</div> <div class="operator">(</div>
	<div class="ident">dbClosedErrorMsg</div>    <div class="operator">=</div> <div class="literal">&#34;sql: database is closed&#34;</div><div class="operator"></div>
	<div class="ident">noSuchTableErrorMsg</div> <div class="operator">=</div> <div class="literal">&#34;no such table: migration_info&#34;</div><div class="operator"></div>
	<div class="ident">stepErrorMsg</div>        <div class="operator">=</div> <div class="literal">&#34;migration Step Error&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

<div class="keyword">var</div> <div class="operator">(</div>
	<div class="ident">stepNoopFn</div> <div class="operator">=</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">_</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">stepErrorFn</div> <div class="operator">=</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">_</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="ident">stepErrorMsg</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">stepRollbackFn</div> <div class="operator">=</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">_</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Rollback</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">testMigration</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">Migration</div><div class="operator">{</div>
		<div class="ident">StepUp</div><div class="operator">:</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">_</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
			<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">&#34;CREATE TABLE migration_test_table (col INTEGER);&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator">,</div>
		<div class="ident">StepDown</div><div class="operator">:</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">,</div> <div class="ident">_</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
			<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">tx</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">&#34;DROP TABLE migration_test_table&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">init</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">zerolog</div><div class="operator">.</div><div class="ident">SetGlobalLevel</div><div class="operator">(</div><div class="ident">zerolog</div><div class="operator">.</div><div class="ident">WarnLevel</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">prepareDB</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">,</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">dbStorage</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">DBStorage</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">dbStorage</div><div class="operator">.</div><div class="ident">GetConnection</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">dbStorage</div><div class="operator">.</div><div class="ident">GetDBDriverType</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">closer</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">,</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDB</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">InitInfoTable</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">prepareDBAndMigrations</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">,</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="operator">*</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migrations</div> <div class="operator">=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migration</div><div class="operator">{</div><div class="ident">testMigration</div><div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestMigrationFull tests majority of the migration
mechanism's functionality, all in one place.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestMigrationFull</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Don't overwrite the migration list, use the real migrations.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndInfo</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">maxVer</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetMaxVersion</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NotEqual</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">,</div> <div class="ident">maxVer</div><div class="operator">,</div> <div class="literal">&#34;no migrations available&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">currentVer</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">Version</div><div class="operator">(</div><div class="literal">0</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">currentVer</div><div class="operator">,</div> <div class="literal">&#34;unexpected version&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">stepUpAndDown</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">maxVer</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">stepUpAndDown</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">,</div> <div class="ident">db</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">dbDriver</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriver</div><div class="operator">,</div> <div class="ident">upVer</div><div class="operator">,</div> <div class="ident">downVer</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">Version</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">upVer</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">currentVer</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">upVer</div><div class="operator">,</div> <div class="ident">currentVer</div><div class="operator">,</div> <div class="literal">&#34;unexpected version&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">currentVer</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">downVer</div><div class="operator">,</div> <div class="ident">currentVer</div><div class="operator">,</div> <div class="literal">&#34;unexpected version&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestMigrationInit checks that database migration table initialization succeeds.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestMigrationInit</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDB</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">InitInfoTable</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestMigrationReInit checks that an attempt to re-initialize an already initialized
migration info table will simply result in a no-op without any error.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestMigrationReInit</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndMigrations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">InitInfoTable</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigrationInitNotOneRow</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndMigrations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO migration_info(version) VALUES(10);&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">const</div> <div class="ident">expectedErrStr</div> <div class="operator">=</div> <div class="literal">&#34;unexpected number of rows in migration info table (expected: 1, reality: 2)&#34;</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">InitInfoTable</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">expectedErrStr</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestMigrationGetVersion checks that the initial database migration version is 0.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestMigrationGetVersion</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndMigrations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">version</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">Version</div><div class="operator">(</div><div class="literal">0</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">version</div><div class="operator">,</div> <div class="literal">&#34;unexpected database version&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigrationGetVersionMissingInfoTable</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Prepare DB without preparing the migration info table.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">db</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDB</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">noSuchTableErrorMsg</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigrationGetVersionMultipleRows</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndMigrations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO migration_info(version) VALUES(10);&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;migration info table contain 2 rows&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigrationGetVersionEmptyTable</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndMigrations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">&#34;DELETE FROM migration_info;&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;migration info table contain 0 rows&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigrationGetVersionInvalidType</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDB</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">&#34;CREATE TABLE migration_info ( version TEXT );&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO migration_info(version) VALUES(&#39;hello world&#39;);&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">const</div> <div class="ident">expectedErrStr</div> <div class="operator">=</div> <div class="literal">`sql: Scan error on column index 0, name &#34;version&#34;: `</div> <div class="operator">&#43;</div>
		<div class="literal">`converting driver.Value type string (&#34;hello world&#34;) to a uint: invalid syntax`</div><div class="operator"></div>
	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">expectedErrStr</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestMigrationSetVersion checks that it is possible to change
the database version in both direction (upgrade and downgrade).</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestMigrationSetVersion</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndMigrations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Step-up from 0 to 1.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">version</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">Version</div><div class="operator">(</div><div class="literal">1</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">version</div><div class="operator">,</div> <div class="literal">&#34;unexpected database version&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Step-down from 1 to 0.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">version</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">Version</div><div class="operator">(</div><div class="literal">0</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">version</div><div class="operator">,</div> <div class="literal">&#34;unexpected database version&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigrationNoInfoTable</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDB</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Intentionally missing info table initialization here.</p>
</td>
	<td class="code"><pre><code>
	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div>
		<div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">noSuchTableErrorMsg</div><div class="operator">,</div> <div class="literal">&#34;migration info table should be missing when not initialized&#34;</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigrationSetVersionSame</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndMigrations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Step-up from 0 to 1.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Set version to.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">version</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">Version</div><div class="operator">(</div><div class="literal">1</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">version</div><div class="operator">,</div> <div class="literal">&#34;unexpected database version&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigrationSetVersionTargetTooHigh</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndMigrations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Step-up from 0 to 2 (impossible -- only 1 migration is available).</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">2</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;invalid target version (available version range is 0-1)&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestMigrationSetVersionUpError checks that an error during a step-up is correctly handled.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestMigrationSetVersionUpError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndMigrations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="operator">*</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migrations</div> <div class="operator">=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migration</div><div class="operator">{</div>
		<div class="operator">{</div>
			<div class="ident">StepUp</div><div class="operator">:</div>   <div class="ident">stepErrorFn</div><div class="operator">,</div>
			<div class="ident">StepDown</div><div class="operator">:</div> <div class="ident">stepNoopFn</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">stepErrorMsg</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestMigrationSetVersionDownError checks that an error during a step-down is correctly handled.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestMigrationSetVersionDownError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndMigrations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="operator">*</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migrations</div> <div class="operator">=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migration</div><div class="operator">{</div>
		<div class="operator">{</div>
			<div class="ident">StepUp</div><div class="operator">:</div>   <div class="ident">stepNoopFn</div><div class="operator">,</div>
			<div class="ident">StepDown</div><div class="operator">:</div> <div class="ident">stepErrorFn</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>First we need to step-up before we can step-down.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">stepErrorMsg</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestMigrationSetVersionCurrentTooHighError makes sure that if the current DB version
is outside of the available migration range, it is reported as an error.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestMigrationSetVersionCurrentTooHighError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndMigrations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">&#34;UPDATE migration_info SET version=10;&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">const</div> <div class="ident">expectedErrStr</div> <div class="operator">=</div> <div class="literal">&#34;current version (10) is outside of available migration boundaries&#34;</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">expectedErrStr</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigrationInitClosedDB</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDB</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Intentionally no <code>defer</code> here.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">InitInfoTable</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">dbClosedErrorMsg</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigrationGetVersionClosedDB</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndMigrations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Intentionally no <code>defer</code> here.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">dbClosedErrorMsg</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigrationSetVersionClosedDB</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndMigrations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Intentionally no <code>defer</code> here.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">dbClosedErrorMsg</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMigrationInitRollbackStep</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDBAndMigrations</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="operator">*</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migrations</div> <div class="operator">=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migration</div><div class="operator">{</div><div class="operator">{</div>
		<div class="ident">StepUp</div><div class="operator">:</div>   <div class="ident">stepRollbackFn</div><div class="operator">,</div>
		<div class="ident">StepDown</div><div class="operator">:</div> <div class="ident">stepNoopFn</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator">}</div><div class="operator"></div>

	<div class="keyword">const</div> <div class="ident">expectedErrStr</div> <div class="operator">=</div> <div class="literal">&#34;sql: transaction has already been committed or rolled back&#34;</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">dbDriver</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">expectedErrStr</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestInitInfoTable_BeginTransactionDBError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">prepareDB</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">InitInfoTable</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;sql: database is closed&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestInitInfoTable_InitTableDBError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">const</div> <div class="ident">errStr</div> <div class="operator">=</div> <div class="literal">&#34;create table error&#34;</div><div class="operator"></div>

	<div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockDBWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustCloseMockDBWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectBegin</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;CREATE TABLE IF NOT EXISTS migration_info&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnError</div><div class="operator">(</div><div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="ident">errStr</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectRollback</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">InitInfoTable</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">errStr</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestInitInfoTable_InitVersionDBError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">const</div> <div class="ident">errStr</div> <div class="operator">=</div> <div class="literal">&#34;insert error&#34;</div><div class="operator"></div>

	<div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockDBWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustCloseMockDBWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectBegin</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;CREATE TABLE IF NOT EXISTS migration_info&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sql_driver</div><div class="operator">.</div><div class="ident">ResultNoRows</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO migration_info&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnError</div><div class="operator">(</div><div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="ident">errStr</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectRollback</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">InitInfoTable</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">errStr</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestInitInfoTable_CountDBError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">const</div> <div class="ident">errStr</div> <div class="operator">=</div> <div class="literal">&#34;count error&#34;</div><div class="operator"></div>

	<div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockDBWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustCloseMockDBWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectBegin</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;CREATE TABLE IF NOT EXISTS migration_info&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sql_driver</div><div class="operator">.</div><div class="ident">ResultNoRows</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO migration_info&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sql_driver</div><div class="operator">.</div><div class="ident">ResultNoRows</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="literal">&#34;SELECT COUNT.&#43;FROM migration_info&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnError</div><div class="operator">(</div><div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="ident">errStr</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectRollback</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">InitInfoTable</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">errStr</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">updateVersionInDBCommon</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">Sqlmock</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>set test migrations</p>
</td>
	<td class="code"><pre><code>	<div class="operator">*</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migrations</div> <div class="operator">=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migration</div><div class="operator">{</div><div class="ident">testMigration</div><div class="operator">}</div><div class="operator"></div>

	<div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockDBWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectBegin</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;CREATE TABLE IF NOT EXISTS migration_info&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sql_driver</div><div class="operator">.</div><div class="ident">ResultNoRows</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO migration_info&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sql_driver</div><div class="operator">.</div><div class="ident">ResultNoRows</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="literal">&#34;SELECT COUNT.&#43;FROM migration_info&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div>
		<div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;version&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="literal">1</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectCommit</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">InitInfoTable</div><div class="operator">(</div><div class="ident">db</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="literal">&#34;SELECT COUNT.&#43;FROM migration_info&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div>
		<div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;version&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="literal">1</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="literal">&#34;SELECT version FROM migration_info&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div>
		<div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;version&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="literal">0</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectBegin</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;CREATE TABLE migration_test_table&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sql_driver</div><div class="operator">.</div><div class="ident">ResultNoRows</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestUpdateVersionInDB_RowsAffectedError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">const</div> <div class="ident">errStr</div> <div class="operator">=</div> <div class="literal">&#34;rows affected error&#34;</div><div class="operator"></div>

	<div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div> <div class="operator">:=</div> <div class="ident">updateVersionInDBCommon</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustCloseMockDBWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;UPDATE migration_info SET version&#34;</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">WithArgs</div><div class="operator">(</div><div class="literal">1</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewErrorResult</div><div class="operator">(</div><div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="ident">errStr</div><div class="operator">)</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverGeneral</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetMaxVersion</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">errStr</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestUpdateVersionInDB_MoreThan1RowAffected</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div> <div class="operator">:=</div> <div class="ident">updateVersionInDBCommon</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustCloseMockDBWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;UPDATE migration_info SET version&#34;</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">WithArgs</div><div class="operator">(</div><div class="literal">1</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewResult</div><div class="operator">(</div><div class="literal">1</div><div class="operator">,</div> <div class="literal">2</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>set test migrations</p>
</td>
	<td class="code"><pre><code>	<div class="operator">*</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migrations</div> <div class="operator">=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">migration</div><div class="operator">.</div><div class="ident">Migration</div><div class="operator">{</div><div class="ident">testMigration</div><div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">SetDBVersion</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverGeneral</div><div class="operator">,</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">GetMaxVersion</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div>
		<div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;unexpected number of affected rows in migration info table (expected: 1, reality: 2)&#34;</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestWithTransaction_Panic</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">const</div> <div class="ident">errStr</div> <div class="operator">=</div> <div class="literal">&#34;panic&#34;</div><div class="operator"></div>

	<div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockDBWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustCloseMockDBWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">expects</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectBegin</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectRollback</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">p</div> <div class="operator">:=</div> <div class="ident">recover</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">p</div><div class="operator">,</div> <div class="ident">errStr</div><div class="operator">,</div> <div class="literal">&#34;panic is expected&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div> <div class="operator">=</div> <div class="ident">migration</div><div class="operator">.</div><div class="ident">WithTransaction</div><div class="operator">(</div><div class="ident">db</div><div class="operator">,</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">tx</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">Tx</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
		<div class="ident">panic</div><div class="operator">(</div><div class="ident">errStr</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">t</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;not expected to go here&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
