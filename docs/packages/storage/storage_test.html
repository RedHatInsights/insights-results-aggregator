<!DOCTYPE html>
<!--
 Copyright 2020 Red Hat, Inc

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
<head>
<title>storage_test.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>storage_test.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"></td>
	<td class="code"><pre><code><div class="comment">/*
Copyright Â© 2020 Red Hat, Inc.

Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/</div>

<div class="keyword">package</div> <div class="ident">storage_test</div><div class="operator"></div>

<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;bytes&#34;</div><div class="operator"></div>
	<div class="literal">&#34;database/sql&#34;</div><div class="operator"></div>
	<div class="literal">&#34;database/sql/driver&#34;</div><div class="operator"></div>
	<div class="literal">&#34;fmt&#34;</div><div class="operator"></div>
	<div class="literal">&#34;os&#34;</div><div class="operator"></div>
	<div class="literal">&#34;strings&#34;</div><div class="operator"></div>
	<div class="literal">&#34;testing&#34;</div><div class="operator"></div>
	<div class="literal">&#34;time&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/DATA-DOG/go-sqlmock&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-operator-utils/tests/helpers&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator-data/testdata&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/Shopify/sarama&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/rs/zerolog&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/rs/zerolog/log&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/stretchr/testify/assert&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/storage&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/types&#34;</div><div class="operator"></div>

	<div class="ident">ira_helpers</div> <div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/tests/helpers&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">init</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">zerolog</div><div class="operator">.</div><div class="ident">SetGlobalLevel</div><div class="operator">(</div><div class="ident">zerolog</div><div class="operator">.</div><div class="ident">WarnLevel</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">assertNumberOfReports</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">,</div> <div class="ident">mockStorage</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">Storage</div><div class="operator">,</div> <div class="ident">expectedNumberOfReports</div> <div class="ident">int</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">numberOfReports</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ReportsCount</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">expectedNumberOfReports</div><div class="operator">,</div> <div class="ident">numberOfReports</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">checkReportForCluster</div><div class="operator">(</div>
	<div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">,</div>
	<div class="ident">s</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">Storage</div><div class="operator">,</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">expected</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to read report for cluster</p>
</td>
	<td class="code"><pre><code>	<div class="ident">result</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">s</div><div class="operator">.</div><div class="ident">ReadReportForCluster</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>and check the read report with expected one</p>
</td>
	<td class="code"><pre><code>	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">expected</div><div class="operator">,</div> <div class="ident">result</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">writeReportForCluster</div><div class="operator">(</div>
	<div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">,</div>
	<div class="ident">storage</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">Storage</div><div class="operator">,</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">clusterReport</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">,</div>
	<div class="ident">rules</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ReportItem</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">WriteReportForCluster</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">clusterReport</div><div class="operator">,</div> <div class="ident">rules</div><div class="operator">,</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestNewStorage checks whether constructor for new storage returns error for improper storage configuration</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestNewStorageError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">Configuration</div><div class="operator">{</div>
		<div class="ident">Driver</div><div class="operator">:</div> <div class="literal">&#34;non existing driver&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;driver non existing driver is not supported&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestNewStorageWithLogging tests creating new storage with logs</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestNewStorageWithLoggingError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">s</div><div class="operator">,</div> <div class="ident">_</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">Configuration</div><div class="operator">{</div>
		<div class="ident">Driver</div><div class="operator">:</div>        <div class="literal">&#34;postgres&#34;</div><div class="operator">,</div>
		<div class="ident">PGPort</div><div class="operator">:</div>        <div class="literal">1234</div><div class="operator">,</div>
		<div class="ident">PGUsername</div><div class="operator">:</div>    <div class="literal">&#34;user&#34;</div><div class="operator">,</div>
		<div class="ident">LogSQLQueries</div><div class="operator">:</div> <div class="ident">true</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">s</div><div class="operator">.</div><div class="ident">Init</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Contains</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="literal">&#34;connect: connection refused&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDBStorageReadReportForClusterEmptyTable check the behaviour of method ReadReportForCluster</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDBStorageReadReportForClusterEmptyTable</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ReadReportForCluster</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">ok</div> <div class="operator">:=</div> <div class="ident">err</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ItemNotFoundError</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">||</div> <div class="operator">!</div><div class="ident">ok</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Fatalf</div><div class="operator">(</div><div class="literal">&#34;expected ItemNotFoundError, got %T, %&#43;v&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div>
		<div class="ident">t</div><div class="operator">,</div>
		<div class="ident">err</div><div class="operator">,</div>
		<div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div>
			<div class="literal">&#34;Item with ID %v/%v was not found in the storage&#34;</div><div class="operator">,</div>
			<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="operator">)</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDBStorageReadReportForClusterClosedStorage check the behaviour of method ReadReportForCluster</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDBStorageReadReportForClusterClosedStorage</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>we need to close storage right now</p>
</td>
	<td class="code"><pre><code>	<div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ReadReportForCluster</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;sql: database is closed&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDBStorageReadReportForCluster check the behaviour of method ReadReportForCluster</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDBStorageReadReportForCluster</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">writeReportForCluster</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="literal">`{&#34;report&#34;:{}}`</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ReportEmptyRulesParsed</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">checkReportForCluster</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="literal">`{&#34;report&#34;:{}}`</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDBStorageGetOrgIDByClusterID check the behaviour of method GetOrgIDByClusterID</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDBStorageGetOrgIDByClusterID</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">writeReportForCluster</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="literal">`{&#34;report&#34;:{}}`</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ReportEmptyRulesParsed</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">orgID</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">GetOrgIDByClusterID</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorageGetOrgIDByClusterID_Error</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">dbStorage</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">DBStorage</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">connection</div> <div class="operator">:=</div> <div class="ident">dbStorage</div><div class="operator">.</div><div class="ident">GetConnection</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">query</div> <div class="operator">:=</div> <div class="literal">`
		CREATE TABLE report (
			org_id          VARCHAR  NOT NULL,
			cluster         VARCHAR  NOT NULL,
			report          VARCHAR NOT NULL,
			reported_at     TIMESTAMP,
			last_checked_at TIMESTAMP,
			kafka_offset BIGINT NOT NULL DEFAULT 0,
			PRIMARY KEY(org_id, cluster)
		);
	`</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>create a table with a bad type for org_id</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">connection</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">query</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>insert some data</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">connection</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO report (org_id, cluster, report, reported_at, last_checked_at)
		VALUES ($1, $2, $3, $4, $5);
	`</div><div class="operator">,</div> <div class="literal">&#34;not-int&#34;</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReportEmpty</div><div class="operator">,</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">GetOrgIDByClusterID</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div>
		<div class="ident">t</div><div class="operator">,</div>
		<div class="ident">err</div><div class="operator">,</div>
		<div class="literal">`sql: Scan error on column index 0, name &#34;org_id&#34;: `</div><div class="operator">&#43;</div>
			<div class="literal">`converting driver.Value type string (&#34;not-int&#34;) to a uint64: invalid syntax`</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDBStorageGetOrgIDByClusterIDFailing check the behaviour of method GetOrgIDByClusterID for not existed ClusterID</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDBStorageGetOrgIDByClusterIDFailing</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">orgID</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">GetOrgIDByClusterID</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;sql: no rows in result set&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">(</div><div class="literal">0</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDBStorageReadReportNoTable check the behaviour of method ReadReportForCluster
when the table with results does not exist</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDBStorageReadReportNoTable</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ReadReportForCluster</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;no such table: report&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDBStorageWriteReportForClusterClosedStorage check the behaviour of method WriteReportForCluster</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDBStorageWriteReportForClusterClosedStorage</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>we need to close storage right now</p>
</td>
	<td class="code"><pre><code>	<div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">WriteReportForCluster</div><div class="operator">(</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReportEmpty</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ReportEmptyRulesParsed</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;sql: database is closed&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDBStorageWriteReportForClusterClosedStorage check the behaviour of method WriteReportForCluster</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDBStorageWriteReportForClusterUnsupportedDriverError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">fakeStorage</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">NewFromConnection</div><div class="operator">(</div><div class="ident">nil</div><div class="operator">,</div> <div class="operator">-</div><div class="literal">1</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>no need to close it</p>
</td>
	<td class="code"><pre><code>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">fakeStorage</div><div class="operator">.</div><div class="ident">WriteReportForCluster</div><div class="operator">(</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReportEmpty</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ReportEmptyRulesParsed</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;writing report with DB -1 is not supported&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDBStorageWriteReportForClusterMoreRecentInDB checks that older report
will not replace a more recent one when writing a report to storage.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDBStorageWriteReportForClusterMoreRecentInDB</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">newerTime</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">UTC</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">olderTime</div> <div class="operator">:=</div> <div class="ident">newerTime</div><div class="operator">.</div><div class="ident">Add</div><div class="operator">(</div><div class="operator">-</div><div class="ident">time</div><div class="operator">.</div><div class="ident">Hour</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Insert newer report.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">WriteReportForCluster</div><div class="operator">(</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReportEmpty</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ReportEmptyRulesParsed</div><div class="operator">,</div>
		<div class="ident">newerTime</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Try to insert older report.</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">WriteReportForCluster</div><div class="operator">(</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReportEmpty</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ReportEmptyRulesParsed</div><div class="operator">,</div>
		<div class="ident">olderTime</div><div class="operator">,</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrOldReport</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDBStorageWriteReportForClusterDroppedReportTable checks the error
returned when trying to SELECT from a dropped/missing report table.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDBStorageWriteReportForClusterDroppedReportTable</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">connection</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">GetConnection</div><div class="operator">(</div><div class="ident">mockStorage</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">DBStorage</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">query</div> <div class="operator">:=</div> <div class="literal">&#34;DROP TABLE report&#34;</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">os</div><div class="operator">.</div><div class="ident">Getenv</div><div class="operator">(</div><div class="literal">&#34;INSIGHTS_RESULTS_AGGREGATOR__TESTS_DB&#34;</div><div class="operator">)</div> <div class="operator">==</div> <div class="literal">&#34;postgres&#34;</div> <div class="operator">{</div>
		<div class="ident">query</div> <div class="operator">&#43;=</div> <div class="literal">&#34; CASCADE&#34;</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">query</div> <div class="operator">&#43;=</div> <div class="literal">&#34;;&#34;</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">connection</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">query</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">WriteReportForCluster</div><div class="operator">(</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReportEmpty</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ReportEmptyRulesParsed</div><div class="operator">,</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;no such table: report&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorageWriteReportForClusterExecError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">createReportTableWithBadClusterField</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">query</div> <div class="operator">=</div> <div class="literal">`
		CREATE TABLE rule_hit (
			org_id          INTEGER NOT NULL,
			cluster_id      VARCHAR NOT NULL,
			rule_id         VARCHAR NOT NULL,
			error_key       VARCHAR NOT NULL,
			report          VARCHAR NOT NULL,
			PRIMARY KEY(cluster_id, org_id, rule_id, error_key)
		)
	`</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>create a rule hit table</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">connection</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">query</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">WriteReportForCluster</div><div class="operator">(</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">Report3Rules</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">Report3RulesParsed</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">const</div> <div class="ident">sqliteErrMessage</div> <div class="operator">=</div> <div class="literal">&#34;CHECK constraint failed: report&#34;</div><div class="operator"></div>
	<div class="keyword">const</div> <div class="ident">postgresErrMessage</div> <div class="operator">=</div> <div class="literal">&#34;pq: invalid input syntax for integer&#34;</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">!=</div> <div class="ident">sqliteErrMessage</div> <div class="operator">&amp;&amp;</div> <div class="operator">!</div><div class="ident">strings</div><div class="operator">.</div><div class="ident">HasPrefix</div><div class="operator">(</div><div class="ident">err</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">postgresErrMessage</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">t</div><div class="operator">.</div><div class="ident">Fatalf</div><div class="operator">(</div><div class="literal">&#34;expected on of: \n%v\n%v\ngot:\n%v&#34;</div><div class="operator">,</div> <div class="ident">sqliteErrMessage</div><div class="operator">,</div> <div class="ident">postgresErrMessage</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorageWriteReportForClusterFakePostgresOK</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">expects</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorageWithExpectsForDriver</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">DBDriverPostgres</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustCloseMockStorageWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">expects</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectBegin</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="literal">`SELECT last_checked_at FROM report`</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">WillReturnRows</div><div class="operator">(</div><div class="ident">expects</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;last_checked_at&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">RowsWillBeClosed</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;DELETE FROM rule_hit&#34;</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">driver</div><div class="operator">.</div><div class="ident">ResultNoRows</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">i</div> <div class="operator">:=</div> <div class="literal">0</div><div class="operator">;</div> <div class="ident">i</div> <div class="operator">&lt;</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">Report3RulesParsed</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">i</div><div class="operator">&#43;&#43;</div> <div class="operator">{</div>
		<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO rule_hit&#34;</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">driver</div><div class="operator">.</div><div class="ident">ResultNoRows</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectExec</div><div class="operator">(</div><div class="literal">&#34;INSERT INTO report&#34;</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">WillReturnResult</div><div class="operator">(</div><div class="ident">driver</div><div class="operator">.</div><div class="ident">ResultNoRows</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectCommit</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">WriteReportForCluster</div><div class="operator">(</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">Report3Rules</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">Report3RulesParsed</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDBStorageListOfOrgs check the behaviour of method ListOfOrgs</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDBStorageListOfOrgs</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">writeReportForCluster</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">,</div> <div class="literal">&#34;1deb586c-fb85-4db4-ae5b-139cdbdf77ae&#34;</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReportEmpty</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ReportEmptyRulesParsed</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">writeReportForCluster</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="literal">3</div><div class="operator">,</div> <div class="literal">&#34;a1bf5b15-5229-4042-9825-c69dc36b57f5&#34;</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReportEmpty</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ReportEmptyRulesParsed</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">result</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ListOfOrgs</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">ElementsMatch</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">{</div><div class="literal">1</div><div class="operator">,</div> <div class="literal">3</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">result</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorageListOfOrgsNoTable</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ListOfOrgs</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;no such table: report&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDBStorageListOfOrgsClosedStorage check the behaviour of method ListOfOrgs</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDBStorageListOfOrgsClosedStorage</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>we need to close storage right now</p>
</td>
	<td class="code"><pre><code>	<div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ListOfOrgs</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;sql: database is closed&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDBStorageListOfClustersFor check the behaviour of method ListOfClustersForOrg</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDBStorageListOfClustersForOrg</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">writeReportForCluster</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">,</div> <div class="literal">&#34;eabb4fbf-edfa-45d0-9352-fb05332fdb82&#34;</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReportEmpty</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ReportEmptyRulesParsed</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">writeReportForCluster</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">,</div> <div class="literal">&#34;edf5f242-0c12-4307-8c9f-29dcd289d045&#34;</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReportEmpty</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ReportEmptyRulesParsed</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>also pushing cluster for different org</p>
</td>
	<td class="code"><pre><code>	<div class="ident">writeReportForCluster</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="literal">5</div><div class="operator">,</div> <div class="literal">&#34;4016d01b-62a1-4b49-a36e-c1c5a3d02750&#34;</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReportEmpty</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ReportEmptyRulesParsed</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">result</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ListOfClustersForOrg</div><div class="operator">(</div><div class="literal">1</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">ElementsMatch</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">{</div>
		<div class="literal">&#34;eabb4fbf-edfa-45d0-9352-fb05332fdb82&#34;</div><div class="operator">,</div>
		<div class="literal">&#34;edf5f242-0c12-4307-8c9f-29dcd289d045&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator">,</div> <div class="ident">result</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">result</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ListOfClustersForOrg</div><div class="operator">(</div><div class="literal">5</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">{</div><div class="literal">&#34;4016d01b-62a1-4b49-a36e-c1c5a3d02750&#34;</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">result</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorageListOfClustersNoTable</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ListOfClustersForOrg</div><div class="operator">(</div><div class="literal">5</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;no such table: report&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestDBStorageListOfClustersClosedStorage check the behaviour of method ListOfOrgs</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestDBStorageListOfClustersClosedStorage</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>we need to close storage right now</p>
</td>
	<td class="code"><pre><code>	<div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ListOfClustersForOrg</div><div class="operator">(</div><div class="literal">5</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;sql: database is closed&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TestMockDBReportsCount check the behaviour of method ReportsCount</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">TestMockDBReportsCount</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assertNumberOfReports</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">writeReportForCluster</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="literal">5</div><div class="operator">,</div> <div class="literal">&#34;4016d01b-62a1-4b49-a36e-c1c5a3d02750&#34;</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReportEmpty</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ReportEmptyRulesParsed</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assertNumberOfReports</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMockDBReportsCountNoTable</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ReportsCount</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;no such table: report&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestMockDBReportsCountClosedStorage</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>we need to close storage right now</p>
</td>
	<td class="code"><pre><code>	<div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ReportsCount</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;sql: database is closed&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorageNewPostgresqlError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">s</div><div class="operator">,</div> <div class="ident">_</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">Configuration</div><div class="operator">{</div>
		<div class="ident">Driver</div><div class="operator">:</div>     <div class="literal">&#34;postgres&#34;</div><div class="operator">,</div>
		<div class="ident">PGHost</div><div class="operator">:</div>     <div class="literal">&#34;non-existing-host&#34;</div><div class="operator">,</div>
		<div class="ident">PGPort</div><div class="operator">:</div>     <div class="literal">12345</div><div class="operator">,</div>
		<div class="ident">PGUsername</div><div class="operator">:</div> <div class="literal">&#34;user&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">s</div><div class="operator">.</div><div class="ident">Init</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Contains</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="literal">&#34;no such host&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">mustWriteReport</div><div class="operator">(</div>
	<div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">,</div>
	<div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div>
	<div class="ident">orgID</div> <div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div>
	<div class="ident">clusterName</div> <div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div>
	<div class="ident">clusterReport</div> <div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">query</div> <div class="operator">:=</div> <div class="literal">`
		INSERT INTO report(org_id, cluster, report, reported_at, last_checked_at)
		VALUES ($1, $2, $3, $4, $5);
	`</div><div class="operator"></div>

	<div class="ident">statement</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">connection</div><div class="operator">.</div><div class="ident">Prepare</div><div class="operator">(</div><div class="ident">query</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div>
		<div class="ident">orgID</div><div class="operator">,</div>
		<div class="ident">clusterName</div><div class="operator">,</div>
		<div class="ident">clusterReport</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">statement</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorageListOfOrgsLogError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">buf</div> <div class="operator">:=</div> <div class="ident">new</div><div class="operator">(</div><div class="ident">bytes</div><div class="operator">.</div><div class="ident">Buffer</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Logger</div> <div class="operator">=</div> <div class="ident">zerolog</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="ident">buf</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">connection</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">GetConnection</div><div class="operator">(</div><div class="ident">mockStorage</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">DBStorage</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>write illegal negative org_id</p>
</td>
	<td class="code"><pre><code>	<div class="ident">mustWriteReport</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">connection</div><div class="operator">,</div> <div class="operator">-</div><div class="literal">1</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReportEmpty</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ListOfOrgs</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Contains</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">buf</div><div class="operator">.</div><div class="ident">String</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="literal">&#34;sql: Scan error&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorageCloseError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">const</div> <div class="ident">errString</div> <div class="operator">=</div> <div class="literal">&#34;unable to close the database&#34;</div><div class="operator"></div>

	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">expects</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorageWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectClose</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnError</div><div class="operator">(</div><div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="ident">errString</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">errString</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorageListOfClustersForOrgScanError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>just for the coverage, because this error can't happen ever because we use
not null in table creation</p>
</td>
	<td class="code"><pre><code>	<div class="ident">buf</div> <div class="operator">:=</div> <div class="ident">new</div><div class="operator">(</div><div class="ident">bytes</div><div class="operator">.</div><div class="ident">Buffer</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Logger</div> <div class="operator">=</div> <div class="ident">zerolog</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="ident">buf</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">expects</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorageWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustCloseMockStorageWithExpects</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">expects</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">expects</div><div class="operator">.</div><div class="ident">ExpectQuery</div><div class="operator">(</div><div class="literal">&#34;SELECT cluster FROM report&#34;</div><div class="operator">)</div><div class="operator">.</div><div class="ident">WillReturnRows</div><div class="operator">(</div>
		<div class="ident">sqlmock</div><div class="operator">.</div><div class="ident">NewRows</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;cluster&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator">.</div><div class="ident">AddRow</div><div class="operator">(</div><div class="ident">nil</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ListOfClustersForOrg</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Contains</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">buf</div><div class="operator">.</div><div class="ident">String</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="literal">&#34;converting NULL to string is unsupported&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorageDeleteReports</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">functionName</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div>
		<div class="literal">&#34;DeleteReportsForOrg&#34;</div><div class="operator">,</div> <div class="literal">&#34;DeleteReportsForCluster&#34;</div><div class="operator">,</div>
	<div class="operator">}</div> <div class="operator">{</div>
		<div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
			<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">assertNumberOfReports</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

			<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">WriteReportForCluster</div><div class="operator">(</div>
				<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
				<div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
				<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Report3Rules</div><div class="operator">,</div>
				<div class="ident">testdata</div><div class="operator">.</div><div class="ident">Report3RulesParsed</div><div class="operator">,</div>
				<div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
				<div class="ident">testdata</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">,</div>
			<div class="operator">)</div><div class="operator"></div>
			<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

			<div class="ident">assertNumberOfReports</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>

			<div class="keyword">switch</div> <div class="ident">functionName</div> <div class="operator">{</div>
			<div class="keyword">case</div> <div class="literal">&#34;DeleteReportsForOrg&#34;</div><div class="operator">:</div>
				<div class="ident">err</div> <div class="operator">=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">DeleteReportsForOrg</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">case</div> <div class="literal">&#34;DeleteReportsForCluster&#34;</div><div class="operator">:</div>
				<div class="ident">err</div> <div class="operator">=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">DeleteReportsForCluster</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">default</div><div class="operator">:</div>
				<div class="ident">t</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;unexpected function name&#34;</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
			<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

			<div class="ident">assertNumberOfReports</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorage_ReadReportForClusterByClusterName_OK</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">mustWriteReport3Rules</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">report</div><div class="operator">,</div> <div class="ident">lastCheckedAt</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ReadReportForClusterByClusterName</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">Report3Rules</div><div class="operator">,</div> <div class="ident">report</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">.</div><div class="ident">UTC</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Format</div><div class="operator">(</div><div class="ident">time</div><div class="operator">.</div><div class="ident">RFC3339</div><div class="operator">)</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">lastCheckedAt</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorage_CheckIfClusterExists_ClusterDoesNotExist</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ReadReportForClusterByClusterName</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div>
		<div class="ident">t</div><div class="operator">,</div>
		<div class="ident">err</div><div class="operator">,</div>
		<div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="literal">&#34;Item with ID %v was not found in the storage&#34;</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorage_CheckIfClusterExists_DBError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">ReadReportForClusterByClusterName</div><div class="operator">(</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">,</div> <div class="literal">&#34;sql: database is closed&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorage_NewSQLite</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">Configuration</div><div class="operator">{</div>
		<div class="ident">Driver</div><div class="operator">:</div>           <div class="literal">&#34;sqlite3&#34;</div><div class="operator">,</div>
		<div class="ident">SQLiteDataSource</div><div class="operator">:</div> <div class="literal">&#34;:memory:&#34;</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorageWriteConsumerError</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">testTopic</div> <div class="operator">:=</div> <div class="literal">&#34;topic&#34;</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">testPartition</div> <div class="ident">int32</div> <div class="operator">=</div> <div class="literal">2</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">testOffset</div> <div class="ident">int64</div> <div class="operator">=</div> <div class="literal">10</div><div class="operator"></div>
	<div class="ident">testKey</div> <div class="operator">:=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">byte</div><div class="operator">(</div><div class="literal">&#34;key&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">testMessage</div> <div class="operator">:=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">byte</div><div class="operator">(</div><div class="literal">&#34;value&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">testProducedAt</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Add</div><div class="operator">(</div><div class="operator">-</div><div class="ident">time</div><div class="operator">.</div><div class="ident">Hour</div><div class="operator">)</div><div class="operator">.</div><div class="ident">UTC</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">testError</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;Consumer error&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">WriteConsumerError</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">sarama</div><div class="operator">.</div><div class="ident">ConsumerMessage</div><div class="operator">{</div>
		<div class="ident">Topic</div><div class="operator">:</div>     <div class="ident">testTopic</div><div class="operator">,</div>
		<div class="ident">Partition</div><div class="operator">:</div> <div class="ident">testPartition</div><div class="operator">,</div>
		<div class="ident">Offset</div><div class="operator">:</div>    <div class="ident">testOffset</div><div class="operator">,</div>
		<div class="ident">Key</div><div class="operator">:</div>       <div class="ident">testKey</div><div class="operator">,</div>
		<div class="ident">Value</div><div class="operator">:</div>     <div class="ident">testMessage</div><div class="operator">,</div>
		<div class="ident">Timestamp</div><div class="operator">:</div> <div class="ident">testProducedAt</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator">,</div> <div class="ident">testError</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">conn</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">GetConnection</div><div class="operator">(</div><div class="ident">mockStorage</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">DBStorage</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">row</div> <div class="operator">:=</div> <div class="ident">conn</div><div class="operator">.</div><div class="ident">QueryRow</div><div class="operator">(</div><div class="literal">`
		SELECT key, message, produced_at, consumed_at, error
		FROM consumer_error
		WHERE topic = $1 AND partition = $2 AND topic_offset = $3
	`</div><div class="operator">,</div> <div class="ident">testTopic</div><div class="operator">,</div> <div class="ident">testPartition</div><div class="operator">,</div> <div class="ident">testOffset</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">storageKey</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">byte</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">storageMessage</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">byte</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">storageProducedAt</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">storageConsumedAt</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">storageError</div> <div class="ident">string</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">row</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">storageKey</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">storageMessage</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">storageProducedAt</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">storageConsumedAt</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">storageError</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">NoError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">testKey</div><div class="operator">,</div> <div class="ident">storageKey</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">testMessage</div><div class="operator">,</div> <div class="ident">storageMessage</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">testProducedAt</div><div class="operator">.</div><div class="ident">Unix</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">storageProducedAt</div><div class="operator">.</div><div class="ident">Unix</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">True</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">UTC</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">After</div><div class="operator">(</div><div class="ident">storageConsumedAt</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">testError</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">storageError</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorage_GetLatestKafkaOffset</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">offset</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">GetLatestKafkaOffset</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">(</div><div class="literal">0</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">offset</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">mustWriteReport3Rules</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">offset</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">GetLatestKafkaOffset</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">(</div><div class="literal">1</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">offset</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorage_GetLatestKafkaOffset_ZeroOffset</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">offset</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">GetLatestKafkaOffset</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">(</div><div class="literal">0</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">offset</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">WriteReportForCluster</div><div class="operator">(</div>
		<div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">Report3Rules</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">Report3RulesParsed</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">(</div><div class="literal">0</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">offset</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">GetLatestKafkaOffset</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">(</div><div class="literal">0</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">offset</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorage_Init</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">dbStorage</div> <div class="operator">:=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">DBStorage</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">dbStorage</div><div class="operator">.</div><div class="ident">MigrateToLatest</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">mustWriteReport3Rules</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">Init</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">clustersLastChecked</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">GetClustersLastChecked</div><div class="operator">(</div><div class="ident">dbStorage</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Len</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">clustersLastChecked</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">Equal</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">.</div><div class="ident">Unix</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">clustersLastChecked</div><div class="operator">[</div><div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">]</div><div class="operator">.</div><div class="ident">Unix</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">TestDBStorage_Init_Error</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">mockStorage</div><div class="operator">,</div> <div class="ident">closer</div> <div class="operator">:=</div> <div class="ident">ira_helpers</div><div class="operator">.</div><div class="ident">MustGetMockStorage</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">closer</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">createReportTableWithBadClusterField</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">mockStorage</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">connection</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">GetConnection</div><div class="operator">(</div><div class="ident">mockStorage</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">DBStorage</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>create a table with a bad type</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">connection</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="literal">`
		INSERT INTO report (org_id, cluster, report, reported_at, last_checked_at)
		VALUES($1, $2, $3, $4, $5)
	`</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">,</div> <div class="ident">testdata</div><div class="operator">.</div><div class="ident">ClusterReportEmpty</div><div class="operator">,</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">mockStorage</div><div class="operator">.</div><div class="ident">Init</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">assert</div><div class="operator">.</div><div class="ident">EqualError</div><div class="operator">(</div>
		<div class="ident">t</div><div class="operator">,</div>
		<div class="ident">err</div><div class="operator">,</div>
		<div class="literal">`sql: Scan error on column index 0, name &#34;cluster&#34;: `</div><div class="operator">&#43;</div>
			<div class="literal">`unsupported Scan, storing driver.Value type int64 into type *types.ClusterName`</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">createReportTableWithBadClusterField</div><div class="operator">(</div><div class="ident">t</div> <div class="operator">*</div><div class="ident">testing</div><div class="operator">.</div><div class="ident">T</div><div class="operator">,</div> <div class="ident">mockStorage</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">Storage</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">connection</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">GetConnection</div><div class="operator">(</div><div class="ident">mockStorage</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">storage</div><div class="operator">.</div><div class="ident">DBStorage</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">query</div> <div class="operator">:=</div> <div class="literal">`
		CREATE TABLE report (
			org_id          INTEGER NOT NULL,
			cluster         INTEGER NOT NULL UNIQUE CHECK(typeof(cluster) = &#39;integer&#39;),
			report          VARCHAR NOT NULL,
			reported_at     TIMESTAMP,
			last_checked_at TIMESTAMP,
			kafka_offset BIGINT NOT NULL DEFAULT 0,
			PRIMARY KEY(org_id, cluster)
		)
	`</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">os</div><div class="operator">.</div><div class="ident">Getenv</div><div class="operator">(</div><div class="literal">&#34;INSIGHTS_RESULTS_AGGREGATOR__TESTS_DB&#34;</div><div class="operator">)</div> <div class="operator">==</div> <div class="literal">&#34;postgres&#34;</div> <div class="operator">{</div>
		<div class="ident">query</div> <div class="operator">=</div> <div class="literal">`
			CREATE TABLE report (
				org_id          INTEGER NOT NULL,
				cluster         INTEGER NOT NULL UNIQUE,
				report          VARCHAR NOT NULL,
				reported_at     TIMESTAMP,
				last_checked_at TIMESTAMP,
				kafka_offset BIGINT NOT NULL DEFAULT 0,
				PRIMARY KEY(org_id, cluster)
			)
		`</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>create a table with a bad type</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">connection</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">query</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">helpers</div><div class="operator">.</div><div class="ident">FailOnError</div><div class="operator">(</div><div class="ident">t</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
