<!DOCTYPE html>
<!--
 Copyright 2020 Red Hat, Inc

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
<head>
<title>processing.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>processing.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"><p>Copyright 2020 Red Hat, Inc</p>

<p>Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<pre><code> http://www.apache.org/licenses/LICENSE-2.0
</code></pre>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</td>
	<td class="code"><pre><code><div class="keyword">package</div> <div class="ident">consumer</div><div class="operator"></div>

<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;encoding/json&#34;</div><div class="operator"></div>
	<div class="literal">&#34;errors&#34;</div><div class="operator"></div>
	<div class="literal">&#34;time&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/Shopify/sarama&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/google/uuid&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/rs/zerolog/log&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/metrics&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/producer&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/types&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Report represents report send in a message consumed from any broker</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">Report</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">string</div><div class="operator">]</div><div class="operator">*</div><div class="ident">json</div><div class="operator">.</div><div class="ident">RawMessage</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>incomingMessage is representation of message consumed from any broker</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">incomingMessage</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">Organization</div> <div class="operator">*</div><div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div>       <div class="literal">`json:&#34;OrgID&#34;`</div><div class="operator"></div>
	<div class="ident">ClusterName</div>  <div class="operator">*</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div> <div class="literal">`json:&#34;ClusterName&#34;`</div><div class="operator"></div>
	<div class="ident">Report</div>       <div class="operator">*</div><div class="ident">Report</div>            <div class="literal">`json:&#34;Report&#34;`</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>LastChecked is a date in format &quot;2020-01-23T16:15:59.478901889Z&quot;</p>
</td>
	<td class="code"><pre><code>	<div class="ident">LastChecked</div> <div class="ident">string</div>          <div class="literal">`json:&#34;LastChecked&#34;`</div><div class="operator"></div>
	<div class="ident">RequestID</div>   <div class="ident">types</div><div class="operator">.</div><div class="ident">RequestID</div> <div class="literal">`json:&#34;RequestId&#34;`</div><div class="operator"></div>
	<div class="ident">ParsedHits</div>  <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ReportItem</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>HandleMessage handles the message and does all logging, metrics, etc</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">consumer</div> <div class="operator">*</div><div class="ident">KafkaConsumer</div><div class="operator">)</div> <div class="ident">HandleMessage</div><div class="operator">(</div><div class="ident">msg</div> <div class="operator">*</div><div class="ident">sarama</div><div class="operator">.</div><div class="ident">ConsumerMessage</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int64</div><div class="operator">(</div><div class="ident">offsetKey</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int32</div><div class="operator">(</div><div class="ident">partitionKey</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Partition</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="ident">topicKey</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Topic</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Time</div><div class="operator">(</div><div class="literal">&#34;message_timestamp&#34;</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;started processing message&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">metrics</div><div class="operator">.</div><div class="ident">ConsumedMessages</div><div class="operator">.</div><div class="ident">Inc</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">startTime</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">requestID</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">ProcessMessage</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">timeAfterProcessingMessage</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">messageProcessingDuration</div> <div class="operator">:=</div> <div class="ident">timeAfterProcessingMessage</div><div class="operator">.</div><div class="ident">Sub</div><div class="operator">(</div><div class="ident">startTime</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Seconds</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">consumer</div><div class="operator">.</div><div class="ident">updatePayloadTracker</div><div class="operator">(</div><div class="ident">requestID</div><div class="operator">,</div> <div class="ident">startTime</div><div class="operator">,</div> <div class="ident">producer</div><div class="operator">.</div><div class="ident">StatusReceived</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">consumer</div><div class="operator">.</div><div class="ident">updatePayloadTracker</div><div class="operator">(</div><div class="ident">requestID</div><div class="operator">,</div> <div class="ident">timeAfterProcessingMessage</div><div class="operator">,</div> <div class="ident">producer</div><div class="operator">.</div><div class="ident">StatusMessageProcessed</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int64</div><div class="operator">(</div><div class="ident">offsetKey</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int32</div><div class="operator">(</div><div class="ident">partitionKey</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Partition</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="ident">topicKey</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Topic</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;processing of message took &#39;%v&#39; seconds&#34;</div><div class="operator">,</div> <div class="ident">messageProcessingDuration</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Something went wrong while processing the message.</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">metrics</div><div class="operator">.</div><div class="ident">FailedMessagesProcessingTime</div><div class="operator">.</div><div class="ident">Observe</div><div class="operator">(</div><div class="ident">messageProcessingDuration</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">metrics</div><div class="operator">.</div><div class="ident">ConsumingErrors</div><div class="operator">.</div><div class="ident">Inc</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Error processing message consumed from Kafka&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">consumer</div><div class="operator">.</div><div class="ident">numberOfErrorsConsumingMessages</div><div class="operator">&#43;&#43;</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">Storage</div><div class="operator">.</div><div class="ident">WriteConsumerError</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Unable to write consumer error to storage&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">consumer</div><div class="operator">.</div><div class="ident">updatePayloadTracker</div><div class="operator">(</div><div class="ident">requestID</div><div class="operator">,</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">producer</div><div class="operator">.</div><div class="ident">StatusError</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>The message was processed successfully.</p>
</td>
	<td class="code"><pre><code>		<div class="ident">metrics</div><div class="operator">.</div><div class="ident">SuccessfulMessagesProcessingTime</div><div class="operator">.</div><div class="ident">Observe</div><div class="operator">(</div><div class="ident">messageProcessingDuration</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">consumer</div><div class="operator">.</div><div class="ident">numberOfSuccessfullyConsumedMessages</div><div class="operator">&#43;&#43;</div><div class="operator"></div>

		<div class="ident">consumer</div><div class="operator">.</div><div class="ident">updatePayloadTracker</div><div class="operator">(</div><div class="ident">requestID</div><div class="operator">,</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">producer</div><div class="operator">.</div><div class="ident">StatusSuccess</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">totalMessageDuration</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Since</div><div class="operator">(</div><div class="ident">startTime</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Int64</div><div class="operator">(</div><div class="ident">durationKey</div><div class="operator">,</div> <div class="ident">totalMessageDuration</div><div class="operator">.</div><div class="ident">Milliseconds</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Int64</div><div class="operator">(</div><div class="ident">offsetKey</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Message consumed&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>updatePayloadTracker</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">consumer</div> <div class="ident">KafkaConsumer</div><div class="operator">)</div> <div class="ident">updatePayloadTracker</div><div class="operator">(</div><div class="ident">requestID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">timestamp</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Time</div><div class="operator">,</div> <div class="ident">status</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">payloadTrackerProducer</div><div class="operator">.</div><div class="ident">TrackPayload</div><div class="operator">(</div><div class="ident">requestID</div><div class="operator">,</div> <div class="ident">timestamp</div><div class="operator">,</div> <div class="ident">status</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Warn</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">`Unable to send &#34;%s&#34; update to Payload Tracker service`</div><div class="operator">,</div> <div class="ident">status</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ProcessMessage processes an incoming message</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">consumer</div> <div class="operator">*</div><div class="ident">KafkaConsumer</div><div class="operator">)</div> <div class="ident">ProcessMessage</div><div class="operator">(</div><div class="ident">msg</div> <div class="operator">*</div><div class="ident">sarama</div><div class="operator">.</div><div class="ident">ConsumerMessage</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">tStart</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Int</div><div class="operator">(</div><div class="ident">offsetKey</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">topicKey</div><div class="operator">,</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">Configuration</div><div class="operator">.</div><div class="ident">Topic</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">groupKey</div><div class="operator">,</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">Configuration</div><div class="operator">.</div><div class="ident">Group</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Consumed&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">message</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">parseMessage</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">.</div><div class="ident">Value</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">logUnparsedMessageError</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="literal">&#34;Error parsing message from Kafka&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">logMessageInfo</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Read&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">tRead</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">Configuration</div><div class="operator">.</div><div class="ident">OrgAllowlistEnabled</div> <div class="operator">{</div>
		<div class="ident">logMessageInfo</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Checking organization ID against allow list&#34;</div><div class="operator">)</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="ident">ok</div> <div class="operator">:=</div> <div class="ident">organizationAllowed</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="operator">*</div><div class="ident">message</div><div class="operator">.</div><div class="ident">Organization</div><div class="operator">)</div><div class="operator">;</div> <div class="operator">!</div><div class="ident">ok</div> <div class="operator">{</div>
			<div class="keyword">const</div> <div class="ident">cause</div> <div class="operator">=</div> <div class="literal">&#34;organization ID is not in allow list&#34;</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>now we have all required information about the incoming message,
the right time to record structured log entry</p>
</td>
	<td class="code"><pre><code>			<div class="ident">logMessageError</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="ident">cause</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="ident">cause</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">logMessageInfo</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Organization is in allow list&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
		<div class="ident">logMessageInfo</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Organization allow listing disabled&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">tAllowlisted</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">reportAsStr</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Marshal</div><div class="operator">(</div><div class="operator">*</div><div class="ident">message</div><div class="operator">.</div><div class="ident">Report</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">logMessageError</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Error marshalling report&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">logMessageInfo</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Marshalled&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">tMarshalled</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">lastCheckedTime</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Parse</div><div class="operator">(</div><div class="ident">time</div><div class="operator">.</div><div class="ident">RFC3339Nano</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">LastChecked</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">logMessageError</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Error parsing date from message&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">lastCheckedTimestampLagMinutes</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Sub</div><div class="operator">(</div><div class="ident">lastCheckedTime</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Minutes</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">lastCheckedTimestampLagMinutes</div> <div class="operator">&lt;</div> <div class="literal">0</div> <div class="operator">{</div>
		<div class="ident">logMessageError</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;got a message from the future&#34;</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">metrics</div><div class="operator">.</div><div class="ident">LastCheckedTimestampLagMinutes</div><div class="operator">.</div><div class="ident">Observe</div><div class="operator">(</div><div class="ident">lastCheckedTimestampLagMinutes</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">logMessageInfo</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Time ok&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">tTimeCheck</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">Storage</div><div class="operator">.</div><div class="ident">WriteReportForCluster</div><div class="operator">(</div>
		<div class="operator">*</div><div class="ident">message</div><div class="operator">.</div><div class="ident">Organization</div><div class="operator">,</div>
		<div class="operator">*</div><div class="ident">message</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReport</div><div class="operator">(</div><div class="ident">reportAsStr</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">message</div><div class="operator">.</div><div class="ident">ParsedHits</div><div class="operator">,</div>
		<div class="ident">lastCheckedTime</div><div class="operator">,</div>
		<div class="ident">types</div><div class="operator">.</div><div class="ident">KafkaOffset</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">==</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrOldReport</div> <div class="operator">{</div>
			<div class="ident">logMessageInfo</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Skipping because a more recent report already exists for this cluster&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">logMessageError</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Error writing report to database&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">logMessageInfo</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">,</div> <div class="ident">message</div><div class="operator">,</div> <div class="literal">&#34;Stored&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">tStored</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>log durations for every message consumption steps</p>
</td>
	<td class="code"><pre><code>	<div class="ident">logDuration</div><div class="operator">(</div><div class="ident">tStart</div><div class="operator">,</div> <div class="ident">tRead</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">,</div> <div class="literal">&#34;read&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">logDuration</div><div class="operator">(</div><div class="ident">tRead</div><div class="operator">,</div> <div class="ident">tAllowlisted</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">,</div> <div class="literal">&#34;org_filtering&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">logDuration</div><div class="operator">(</div><div class="ident">tAllowlisted</div><div class="operator">,</div> <div class="ident">tMarshalled</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">,</div> <div class="literal">&#34;marshalling&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">logDuration</div><div class="operator">(</div><div class="ident">tMarshalled</div><div class="operator">,</div> <div class="ident">tTimeCheck</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">,</div> <div class="literal">&#34;time_check&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">logDuration</div><div class="operator">(</div><div class="ident">tTimeCheck</div><div class="operator">,</div> <div class="ident">tStored</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">,</div> <div class="literal">&#34;db_store&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>message has been parsed and stored into storage</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">return</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">RequestID</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>organizationAllowed checks whether the given organization is on allow list or not</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">organizationAllowed</div><div class="operator">(</div><div class="ident">consumer</div> <div class="operator">*</div><div class="ident">KafkaConsumer</div><div class="operator">,</div> <div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">)</div> <div class="ident">bool</div> <div class="operator">{</div>
	<div class="ident">allowList</div> <div class="operator">:=</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">Configuration</div><div class="operator">.</div><div class="ident">OrgAllowlist</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">allowList</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">orgAllowed</div> <div class="operator">:=</div> <div class="ident">allowList</div><div class="operator">.</div><div class="ident">Contains</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">orgAllowed</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>checkReportStructure tests if the report has correct structure</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">checkReportStructure</div><div class="operator">(</div><div class="ident">r</div> <div class="ident">Report</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>the structure is not well defined yet, so all we should do is to check if all keys are there</p>
</td>
	<td class="code"><pre><code>	<div class="ident">expectedKeys</div> <div class="operator">:=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;fingerprints&#34;</div><div class="operator">,</div> <div class="literal">&#34;info&#34;</div><div class="operator">,</div> <div class="literal">&#34;reports&#34;</div><div class="operator">,</div> <div class="literal">&#34;skips&#34;</div><div class="operator">,</div> <div class="literal">&#34;system&#34;</div><div class="operator">}</div><div class="operator"></div>
	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">expectedKey</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">expectedKeys</div> <div class="operator">{</div>
		<div class="ident">_</div><div class="operator">,</div> <div class="ident">found</div> <div class="operator">:=</div> <div class="ident">r</div><div class="operator">[</div><div class="ident">expectedKey</div><div class="operator">]</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="operator">!</div><div class="ident">found</div> <div class="operator">{</div>
			<div class="keyword">return</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;Improper report structure, missing key &#34;</div> <div class="operator">&#43;</div> <div class="ident">expectedKey</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>parseMessage tries to parse incoming message and read all required attributes from it</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">parseMessage</div><div class="operator">(</div><div class="ident">messageValue</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">byte</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">incomingMessage</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">deserialized</div> <div class="ident">incomingMessage</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Unmarshal</div><div class="operator">(</div><div class="ident">messageValue</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">deserialized</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">deserialized</div><div class="operator">.</div><div class="ident">Organization</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;missing required attribute &#39;OrgID&#39;&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">deserialized</div><div class="operator">.</div><div class="ident">ClusterName</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;missing required attribute &#39;ClusterName&#39;&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">deserialized</div><div class="operator">.</div><div class="ident">Report</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;missing required attribute &#39;Report&#39;&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">uuid</div><div class="operator">.</div><div class="ident">Parse</div><div class="operator">(</div><div class="ident">string</div><div class="operator">(</div><div class="operator">*</div><div class="ident">deserialized</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="literal">&#34;cluster name is not a UUID&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">checkReportStructure</div><div class="operator">(</div><div class="operator">*</div><div class="ident">deserialized</div><div class="operator">.</div><div class="ident">Report</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Deserialized report read from message with improper structure: %v&#34;</div><div class="operator">,</div> <div class="operator">*</div><div class="ident">deserialized</div><div class="operator">.</div><div class="ident">Report</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Unmarshal</div><div class="operator">(</div><div class="operator">*</div><div class="operator">(</div><div class="operator">(</div><div class="operator">*</div><div class="ident">deserialized</div><div class="operator">.</div><div class="ident">Report</div><div class="operator">)</div><div class="operator">[</div><div class="literal">&#34;reports&#34;</div><div class="operator">]</div><div class="operator">)</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">deserialized</div><div class="operator">.</div><div class="ident">ParsedHits</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">deserialized</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
